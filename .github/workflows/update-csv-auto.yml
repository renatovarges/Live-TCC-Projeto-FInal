name: ğŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica do CSV

on:
  # Executar a cada 6 horas
  schedule:
    - cron: '0 */6 * * *'  # A cada 6 horas
    # - cron: '0 6 * * *'   # Diariamente Ã s 6h (descomente para usar)
    # - cron: '0 * * * *'   # A cada hora (descomente para usar)
  
  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o mesmo se nÃ£o houver mudanÃ§as'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-csv:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout do repositÃ³rio
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install requests pandas
    
    - name: ğŸ¯ Buscar dados da API do Cartola
      id: fetch-data
      run: |
        python << 'EOF'
        import requests
        import json
        import csv
        import os
        from datetime import datetime
        
        print("ğŸ”„ Iniciando atualizaÃ§Ã£o do CSV...")
        
        # Headers para simular navegador
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'pt-BR,pt;q=0.9,en;q=0.8',
            'Referer': 'https://cartola.globo.com/',
            'Origin': 'https://cartola.globo.com'
        }
        
        try:
            # Buscar dados dos atletas
            print("ğŸ“Š Buscando dados dos atletas...")
            response = requests.get('https://api.cartola.globo.com/atletas/mercado', headers=headers, timeout=30)
            response.raise_for_status()
            data = response.json()
            
            # Buscar status do mercado
            print("ğŸ“ˆ Buscando status do mercado...")
            status_response = requests.get('https://api.cartola.globo.com/mercado/status', headers=headers, timeout=10)
            market_status = status_response.json() if status_response.ok else {}
            
            # Mapeamento de clubes
            club_mapping = {
                263: 'Botafogo', 264: 'Corinthians', 265: 'Bahia', 266: 'Fluminense', 267: 'Vasco',
                275: 'Palmeiras', 276: 'SÃ£o Paulo', 277: 'Santos', 285: 'AtlÃ©tico-MG',
                293: 'GrÃªmio', 294: 'Internacional', 356: 'Fortaleza', 373: 'Cruzeiro',
                1371: 'Juventude', 1372: 'CearÃ¡', 1373: 'Sport', 1376: 'VitÃ³ria',
                1377: 'Red Bull Bragantino', 2305: 'Mirassol'
            }
            
            # Mapeamento de posiÃ§Ãµes
            position_mapping = {
                1: 'Goleiro', 2: 'Lateral', 3: 'Zagueiro', 4: 'Meia', 5: 'Atacante', 6: 'TÃ©cnico'
            }
            
            # Processar dados
            csv_data = []
            processed_count = 0
            
            for atleta in data.get('atletas', {}).values():
                clube_id = atleta.get('clube_id')
                clube_nome = club_mapping.get(clube_id)
                
                if clube_nome and clube_id in data.get('clubes', {}):
                    posicao = position_mapping.get(atleta.get('posicao_id'), 'Meia')
                    nome = (atleta.get('apelido') or atleta.get('nome', '')).replace(',', '')
                    preco = f"{atleta.get('preco_num', 0):.2f}"
                    
                    csv_data.append([nome, clube_nome, posicao, preco])
                    processed_count += 1
            
            # Escrever CSV
            print(f"ğŸ’¾ Salvando {processed_count} jogadores no CSV...")
            with open('cartola_jogadores_time_posicao_preco.csv', 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.writer(csvfile)
                writer.writerow(['Nome', 'Clube', 'Posicao', 'Preco'])
                writer.writerows(csv_data)
            
            # Criar arquivo de log
            log_data = {
                'timestamp': datetime.now().isoformat(),
                'total_atletas': len(data.get('atletas', {})),
                'processed_atletas': processed_count,
                'total_clubes': len(data.get('clubes', {})),
                'rodada_atual': market_status.get('rodada_atual', 'N/A'),
                'status_mercado': market_status.get('status_mercado', 'N/A'),
                'success': True
            }
            
            with open('update_log.json', 'w') as logfile:
                json.dump(log_data, logfile, indent=2)
            
            print(f"âœ… CSV atualizado com sucesso!")
            print(f"ğŸ“Š EstatÃ­sticas:")
            print(f"   - Total de atletas: {len(data.get('atletas', {}))}")
            print(f"   - Atletas processados: {processed_count}")
            print(f"   - Clubes: {len(data.get('clubes', {}))}")
            print(f"   - Rodada atual: {market_status.get('rodada_atual', 'N/A')}")
            
            # Definir outputs para o GitHub Actions
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"success=true\n")
                f.write(f"processed_count={processed_count}\n")
                f.write(f"total_atletas={len(data.get('atletas', {}))}\n")
                f.write(f"rodada_atual={market_status.get('rodada_atual', 'N/A')}\n")
            
        except Exception as e:
            print(f"âŒ Erro: {str(e)}")
            
            # Log de erro
            error_log = {
                'timestamp': datetime.now().isoformat(),
                'error': str(e),
                'success': False
            }
            
            with open('update_log.json', 'w') as logfile:
                json.dump(error_log, logfile, indent=2)
            
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"success=false\n")
                f.write(f"error={str(e)}\n")
            
            exit(1)
        EOF
    
    - name: ğŸ“ Verificar mudanÃ§as no CSV
      id: check-changes
      run: |
        if git diff --quiet cartola_jogadores_time_posicao_preco.csv; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Nenhuma mudanÃ§a detectada no CSV"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ MudanÃ§as detectadas no CSV"
        fi
    
    - name: ğŸ’¾ Commit e Push das mudanÃ§as
      if: steps.check-changes.outputs.changes == 'true' || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - CSV Update"
        
        # Adicionar arquivos modificados
        git add cartola_jogadores_time_posicao_preco.csv
        git add update_log.json
        
        # Criar commit com informaÃ§Ãµes detalhadas
        COMMIT_MSG="ğŸ”„ AtualizaÃ§Ã£o automÃ¡tica do CSV
        
        ğŸ“Š EstatÃ­sticas:
        - Atletas processados: ${{ steps.fetch-data.outputs.processed_count }}
        - Total de atletas: ${{ steps.fetch-data.outputs.total_atletas }}
        - Rodada atual: ${{ steps.fetch-data.outputs.rodada_atual }}
        - Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ğŸ¤– AtualizaÃ§Ã£o automÃ¡tica via GitHub Actions"
        
        git commit -m "$COMMIT_MSG"
        git push
        
        echo "âœ… CSV atualizado e enviado para o repositÃ³rio!"
    
    - name: ğŸ“Š Resumo da execuÃ§Ã£o
      if: always()
      run: |
        echo "## ğŸ“Š Resumo da AtualizaÃ§Ã£o do CSV" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.fetch-data.outputs.success }}" == "true" ]; then
          echo "âœ… **Status**: Sucesso" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **Atletas processados**: ${{ steps.fetch-data.outputs.processed_count }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ† **Total de atletas**: ${{ steps.fetch-data.outputs.total_atletas }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¯ **Rodada atual**: ${{ steps.fetch-data.outputs.rodada_atual }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
            echo "ğŸ”„ **MudanÃ§as**: CSV foi atualizado" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ“Š **MudanÃ§as**: Nenhuma mudanÃ§a detectada" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Status**: Erro" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš¨ **Erro**: ${{ steps.fetch-data.outputs.error }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¤– **Executado por**: GitHub Actions" >> $GITHUB_STEP_SUMMARY
