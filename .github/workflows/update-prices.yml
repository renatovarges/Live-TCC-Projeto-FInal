name: Atualizar Pre√ßos Cartola FC

on:
  schedule:
    # Executa a cada 6 horas (00:30, 06:30, 12:30, 18:30 UTC) - 30min ap√≥s update-csv-auto.yml
    - cron: '30 */6 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'For√ßar atualiza√ß√£o mesmo sem mudan√ßas'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-prices:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: üîç Check for concurrent workflows
      run: |
        echo "üöÄ Iniciando verifica√ß√£o de workflows concorrentes..."
        sleep 10
        echo "‚úÖ Verifica√ß√£o conclu√≠da - prosseguindo com seguran√ßa"
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: üîÑ Update player prices with retry
      run: |
        echo "üöÄ Iniciando atualiza√ß√£o dos pre√ßos dos jogadores..."
        
        # Fun√ß√£o de retry com backoff exponencial
        retry_count=0
        max_retries=3
        
        while [ $retry_count -lt $max_retries ]; do
          echo "üìä Tentativa $((retry_count + 1)) de $max_retries"
          
          if python update_prices.py; then
            echo "‚úÖ Atualiza√ß√£o conclu√≠da com sucesso!"
            break
          else
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
              wait_time=$((2 ** retry_count))
              echo "‚è≥ Falha na tentativa $retry_count. Aguardando ${wait_time}s antes da pr√≥xima tentativa..."
              sleep $wait_time
            else
              echo "‚ùå Todas as tentativas falharam. Abortando."
              exit 1
            fi
          fi
        done
    
    - name: üìä Check for changes and log details
      id: verify-changed-files
      run: |
        echo "üîç Verificando mudan√ßas nos dados..."
        
        if [ -f "cartola_jogadores_time_posicao_preco.csv" ]; then
          lines=$(wc -l < cartola_jogadores_time_posicao_preco.csv)
          players_count=$((lines-1))
          echo "üìà Total de jogadores processados: $players_count"
          echo "players_count=$players_count" >> $GITHUB_OUTPUT
        fi
        
        if [ -n "$(git status --porcelain)" ]; then
          echo "‚úÖ Mudan√ßas detectadas nos dados"
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "‚ÑπÔ∏è Nenhuma mudan√ßa detectada"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
    
    - name: üíæ Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add cartola_jogadores_time_posicao_preco.csv
        
        # Criar mensagem de commit detalhada
        commit_msg="ü§ñ Atualiza√ß√£o autom√°tica dos pre√ßos - $(date +'%d/%m/%Y %H:%M UTC')"
        if [ -n "${{ steps.verify-changed-files.outputs.players_count }}" ]; then
          commit_msg="$commit_msg\n\nüìä Jogadores processados: ${{ steps.verify-changed-files.outputs.players_count }}"
        fi
        
        git commit -m "$commit_msg"
        git push
        
        echo "‚úÖ Dados atualizados e enviados para o reposit√≥rio"
    
    - name: üöÄ Trigger Netlify deploy
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "üåê Disparando deploy do Netlify..."
        curl -X POST -d {} ${{ secrets.NETLIFY_BUILD_HOOK }}
        echo "‚úÖ Deploy disparado com sucesso"
    
    - name: ‚ùå Notify failure
      if: failure()
      run: |
        echo "‚ùå ERRO: Falha na atualiza√ß√£o dos pre√ßos do Cartola FC"
        echo "üïê Hor√°rio: $(date +'%d/%m/%Y %H:%M UTC')"
        echo "üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "üìß Verifique os logs para mais detalhes sobre o erro."
        
        # Criar resumo detalhado do erro
        echo "## ‚ùå Falha na Atualiza√ß√£o dos Pre√ßos" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**üïê Hor√°rio da falha**: $(date +'%d/%m/%Y %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**üîó Link do workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîç Diagn√≥stico" >> $GITHUB_STEP_SUMMARY
        
        # Log de debug
        echo "üìã Status dos arquivos:"
        if ls -la *.csv 2>/dev/null; then
          echo "**üìÅ Arquivos CSV encontrados**" >> $GITHUB_STEP_SUMMARY
        else
          echo "**‚ö†Ô∏è Nenhum arquivo CSV encontrado**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üí° Poss√≠veis Solu√ß√µes" >> $GITHUB_STEP_SUMMARY
        echo "- Verificar se a API do Cartola FC est√° funcionando" >> $GITHUB_STEP_SUMMARY
        echo "- Executar o workflow manualmente para testar" >> $GITHUB_STEP_SUMMARY
        echo "- Verificar se h√° problemas de conectividade" >> $GITHUB_STEP_SUMMARY
        echo "- Aguardar alguns minutos e tentar novamente" >> $GITHUB_STEP_SUMMARY
        
        echo "üìã Status do Git:"
        git status
    
    - name: ‚úÖ Success summary
      if: success()
      run: |
        echo "‚úÖ Workflow executado com sucesso!"
        echo "üïê Hor√°rio: $(date +'%d/%m/%Y %H:%M UTC')"
        
        # Criar resumo detalhado de sucesso
        echo "## ‚úÖ Atualiza√ß√£o dos Pre√ßos Conclu√≠da" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**üïê Hor√°rio de conclus√£o**: $(date +'%d/%m/%Y %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**üîó Link do workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "cartola_jogadores_time_posicao_preco.csv" ]; then
          lines=$(wc -l < cartola_jogadores_time_posicao_preco.csv)
          players_count=$((lines-1))
          echo "üìä Total de jogadores processados: $players_count"
          echo "**üìä Total de jogadores**: $players_count" >> $GITHUB_STEP_SUMMARY
          
          # Verificar tamanho do arquivo
          file_size=$(du -h cartola_jogadores_time_posicao_preco.csv | cut -f1)
          echo "**üìÅ Tamanho do arquivo**: $file_size" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è Arquivo CSV n√£o encontrado"
          echo "**‚ö†Ô∏è Status**: Arquivo CSV n√£o encontrado" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìà Pr√≥ximas Execu√ß√µes" >> $GITHUB_STEP_SUMMARY
        echo "- **Autom√°tica**: A cada 6 horas (00:30, 06:30, 12:30, 18:30 UTC)" >> $GITHUB_STEP_SUMMARY
        echo "- **Manual**: Dispon√≠vel atrav√©s do bot√£o 'Run workflow'" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ü§ñ **Executado por**: GitHub Actions - Update Prices Workflow" >> $GITHUB_STEP_SUMMARY