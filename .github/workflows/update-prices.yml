name: Atualizar PreÃ§os Cartola FC

on:
  schedule:
    # Executa a cada 6 horas (00:30, 06:30, 12:30, 18:30 UTC) - 30min apÃ³s update-csv-auto.yml
    - cron: '30 */6 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o mesmo sem mudanÃ§as'
        required: false
        default: 'false'
        type: boolean

# PermissÃµes explÃ­citas para o GITHUB_TOKEN
permissions:
  contents: write  # NecessÃ¡rio para fazer push de mudanÃ§as

jobs:
  update-prices:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ” Check for concurrent workflows
      run: |
        echo "ğŸš€ Iniciando verificaÃ§Ã£o de workflows concorrentes..."
        sleep 10
        echo "âœ… VerificaÃ§Ã£o concluÃ­da - prosseguindo com seguranÃ§a"
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch completo para evitar problemas de histÃ³rico
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # Cache de dependÃªncias para acelerar
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ”„ Update player prices with retry
      id: update_prices
      continue-on-error: true  # NÃ£o abortar workflow se falhar
      run: |
        echo "ğŸš€ Iniciando atualizaÃ§Ã£o dos preÃ§os dos jogadores..."
        
        # Executar o script Python
        if python update_prices.py; then
          echo "âœ… AtualizaÃ§Ã£o concluÃ­da com sucesso!"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Falha na atualizaÃ§Ã£o. Continuando sem atualizaÃ§Ã£o."
          echo "success=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ“Š Check for changes and log details
      id: verify_changes
      run: |
        echo "ğŸ” Verificando mudanÃ§as nos dados..."
        
        # Verificar se o arquivo CSV existe
        if [ ! -f "cartola_jogadores_time_posicao_preco.csv" ]; then
          echo "âš ï¸ Arquivo CSV nÃ£o encontrado!"
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "file_exists=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "file_exists=true" >> $GITHUB_OUTPUT
        
        # Contar jogadores
        lines=$(wc -l < cartola_jogadores_time_posicao_preco.csv)
        players_count=$((lines-1))
        echo "ğŸ“ˆ Total de jogadores no CSV: $players_count"
        echo "players_count=$players_count" >> $GITHUB_OUTPUT
        
        # Verificar mudanÃ§as no Git
        git add cartola_jogadores_time_posicao_preco.csv
        
        if git diff --cached --quiet; then
          echo "â„¹ï¸ Nenhuma mudanÃ§a detectada no CSV"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "âœ… MudanÃ§as detectadas no CSV"
          echo "changed=true" >> $GITHUB_OUTPUT
          
          # Mostrar estatÃ­sticas das mudanÃ§as
          echo "ğŸ“Š EstatÃ­sticas das mudanÃ§as:"
          git diff --cached --stat cartola_jogadores_time_posicao_preco.csv || true
        fi
    
    - name: ğŸ’¾ Commit and push changes
      if: steps.verify_changes.outputs.changed == 'true'
      run: |
        echo "ğŸ’¾ Preparando commit das mudanÃ§as..."
        
        # Configurar Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Criar mensagem de commit detalhada
        commit_msg="ğŸ¤– AtualizaÃ§Ã£o automÃ¡tica dos preÃ§os - $(date +'%d/%m/%Y %H:%M UTC')"
        
        if [ -n "${{ steps.verify_changes.outputs.players_count }}" ]; then
          commit_msg="${commit_msg}\n\nğŸ“Š Jogadores processados: ${{ steps.verify_changes.outputs.players_count }}"
        fi
        
        # Fazer commit
        if git commit -m "${commit_msg}"; then
          echo "âœ… Commit criado com sucesso"
          
          # Fazer push com retry
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ“¤ Tentativa $attempt de $max_attempts: Enviando mudanÃ§as..."
            
            if git push; then
              echo "âœ… MudanÃ§as enviadas com sucesso!"
              exit 0
            else
              echo "âš ï¸ Falha no push (tentativa $attempt)"
              
              if [ $attempt -lt $max_attempts ]; then
                echo "â³ Aguardando 5 segundos antes de tentar novamente..."
                sleep 5
                
                # Tentar pull antes de push novamente
                echo "ğŸ”„ Sincronizando com repositÃ³rio remoto..."
                git pull --rebase origin main || true
              fi
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "âŒ Falha ao enviar mudanÃ§as apÃ³s $max_attempts tentativas"
          exit 1
        else
          echo "âš ï¸ Nada para commitar (possÃ­vel falso positivo na detecÃ§Ã£o de mudanÃ§as)"
          exit 0
        fi
    
    - name: ğŸ“‹ Generate summary
      if: always()
      run: |
        echo "## ğŸ“Š Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ• HorÃ¡rio**: $(date +'%d/%m/%Y %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ”— Workflow**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Status da atualizaÃ§Ã£o
        if [ "${{ steps.update_prices.outputs.success }}" == "true" ]; then
          echo "âœ… **AtualizaÃ§Ã£o de preÃ§os**: Sucesso" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **AtualizaÃ§Ã£o de preÃ§os**: Falhou (continuou sem atualizaÃ§Ã£o)" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Status do arquivo
        if [ "${{ steps.verify_changes.outputs.file_exists }}" == "true" ]; then
          echo "âœ… **Arquivo CSV**: Existe" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.verify_changes.outputs.players_count }}" ]; then
            echo "ğŸ“Š **Total de jogadores**: ${{ steps.verify_changes.outputs.players_count }}" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Arquivo CSV**: NÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Status das mudanÃ§as
        if [ "${{ steps.verify_changes.outputs.changed }}" == "true" ]; then
          echo "âœ… **MudanÃ§as**: Detectadas e commitadas" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **MudanÃ§as**: Nenhuma mudanÃ§a detectada" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ PrÃ³ximas ExecuÃ§Ãµes" >> $GITHUB_STEP_SUMMARY
        echo "- **AutomÃ¡tica**: A cada 6 horas (00:30, 06:30, 12:30, 18:30 UTC)" >> $GITHUB_STEP_SUMMARY
        echo "- **Manual**: DisponÃ­vel atravÃ©s do botÃ£o 'Run workflow'" >> $GITHUB_STEP_SUMMARY
    
    - name: âŒ Notify failure
      if: failure()
      run: |
        echo "## âŒ Falha na ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ• HorÃ¡rio da falha**: $(date +'%d/%m/%Y %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ”— Link do workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ’¡ PossÃ­veis SoluÃ§Ãµes" >> $GITHUB_STEP_SUMMARY
        echo "- Verificar se a API do Cartola FC estÃ¡ funcionando" >> $GITHUB_STEP_SUMMARY
        echo "- Executar o workflow manualmente para testar" >> $GITHUB_STEP_SUMMARY
        echo "- Verificar os logs detalhados acima" >> $GITHUB_STEP_SUMMARY
        echo "- Aguardar alguns minutos e tentar novamente" >> $GITHUB_STEP_SUMMARY
        
        echo "âŒ ERRO: Falha crÃ­tica na atualizaÃ§Ã£o dos preÃ§os do Cartola FC"
        echo "ğŸ• HorÃ¡rio: $(date +'%d/%m/%Y %H:%M UTC')"
        echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
