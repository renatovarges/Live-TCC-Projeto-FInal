name: ğŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica do CSV

on:
  # Executar a cada 6 horas (horÃ¡rio principal - 00:00, 06:00, 12:00, 18:00 UTC)
  # O workflow update-prices.yml executa 30 minutos depois para evitar conflitos
  schedule:
    - cron: '0 */6 * * *'  # A cada 6 horas
    # - cron: '0 6 * * *'   # Diariamente Ã s 6h (descomente para usar)
    # - cron: '0 * * * *'   # A cada hora (descomente para usar)
  
  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      force_update:
        description: 'ForÃ§ar atualizaÃ§Ã£o mesmo se nÃ£o houver mudanÃ§as'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-csv:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Timeout de 10 minutos
    
    steps:
    - name: ğŸ”„ Checkout do repositÃ³rio
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install requests pandas
    
    - name: ğŸ¯ Buscar dados da API do Cartola (com retry)
      id: fetch-data
      run: |
        python << 'EOF'
        import requests
        import json
        import csv
        import os
        import time
        from datetime import datetime
        
        def fetch_with_retry(url, headers, max_retries=3, delay=5):
            """FunÃ§Ã£o para fazer requisiÃ§Ãµes com retry automÃ¡tico"""
            for attempt in range(max_retries):
                try:
                    print(f"ğŸ”„ Tentativa {attempt + 1}/{max_retries} para {url}")
                    response = requests.get(url, headers=headers, timeout=45)
                    response.raise_for_status()
                    return response
                except Exception as e:
                    print(f"âŒ Tentativa {attempt + 1} falhou: {str(e)}")
                    if attempt < max_retries - 1:
                        print(f"â³ Aguardando {delay} segundos antes da prÃ³xima tentativa...")
                        time.sleep(delay)
                        delay *= 2  # Backoff exponencial
                    else:
                        raise e
        
        print("ğŸ”„ Iniciando atualizaÃ§Ã£o do CSV...")
        
        # Headers mais robustos para simular navegador real
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'pt-BR,pt;q=0.9,en;q=0.8',
            'Accept-Encoding': 'gzip, deflate, br',
            'Referer': 'https://cartola.globo.com/',
            'Origin': 'https://cartola.globo.com',
            'Connection': 'keep-alive',
            'Sec-Fetch-Dest': 'empty',
            'Sec-Fetch-Mode': 'cors',
            'Sec-Fetch-Site': 'same-site'
        }
        
        try:
            # Buscar dados dos atletas com retry
            print("ğŸ“Š Buscando dados dos atletas...")
            response = fetch_with_retry('https://api.cartola.globo.com/atletas/mercado', headers)
            data = response.json()
            
            # Buscar status do mercado com retry (nÃ£o crÃ­tico se falhar)
            print("ğŸ“ˆ Buscando status do mercado...")
            market_status = {}
            try:
                status_response = fetch_with_retry('https://api.cartola.globo.com/mercado/status', headers, max_retries=2)
                market_status = status_response.json()
            except Exception as e:
                print(f"âš ï¸ Aviso: NÃ£o foi possÃ­vel buscar status do mercado: {str(e)}")
                market_status = {'rodada_atual': 'N/A', 'status_mercado': 'N/A'}
            
            # Validar dados recebidos
            if not data or 'atletas' not in data:
                raise ValueError("Dados da API invÃ¡lidos ou vazios")
            
            atletas_count = len(data.get('atletas', {}))
            if atletas_count < 100:  # ValidaÃ§Ã£o bÃ¡sica
                raise ValueError(f"Poucos atletas retornados ({atletas_count}), possÃ­vel problema na API")
            
            # Mapeamento de clubes (atualizado)
            club_mapping = {
                263: 'Botafogo', 264: 'Corinthians', 265: 'Bahia', 266: 'Fluminense', 267: 'Vasco',
                275: 'Palmeiras', 276: 'SÃ£o Paulo', 277: 'Santos', 285: 'AtlÃ©tico-MG',
                293: 'GrÃªmio', 294: 'Internacional', 356: 'Fortaleza', 373: 'Cruzeiro',
                1371: 'Juventude', 1372: 'CearÃ¡', 1373: 'Sport', 1376: 'VitÃ³ria',
                1377: 'Red Bull Bragantino', 2305: 'Mirassol'
            }
            
            # Mapeamento de posiÃ§Ãµes
            position_mapping = {
                1: 'Goleiro', 2: 'Lateral', 3: 'Zagueiro', 4: 'Meia', 5: 'Atacante', 6: 'TÃ©cnico'
            }
            
            # Processar dados
            csv_data = []
            processed_count = 0
            skipped_count = 0
            
            for atleta in data.get('atletas', {}).values():
                clube_id = atleta.get('clube_id')
                clube_nome = club_mapping.get(clube_id)
                
                if clube_nome and clube_id in data.get('clubes', {}):
                    posicao = position_mapping.get(atleta.get('posicao_id'), 'Meia')
                    nome = (atleta.get('apelido') or atleta.get('nome', '')).replace(',', '').strip()
                    preco = f"{atleta.get('preco_num', 0):.2f}"
                    
                    if nome:  # SÃ³ adicionar se tiver nome vÃ¡lido
                        csv_data.append([nome, clube_nome, posicao, preco])
                        processed_count += 1
                    else:
                        skipped_count += 1
                else:
                    skipped_count += 1
            
            # Validar dados processados
            if processed_count < 50:
                raise ValueError(f"Poucos jogadores processados ({processed_count}), possÃ­vel problema nos dados")
            
            # Escrever CSV
            print(f"ğŸ’¾ Salvando {processed_count} jogadores no CSV...")
            with open('cartola_jogadores_time_posicao_preco.csv', 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.writer(csvfile)
                writer.writerow(['Nome', 'Clube', 'Posicao', 'Preco'])
                writer.writerows(csv_data)
            
            # Criar arquivo de log detalhado
            log_data = {
                'timestamp': datetime.now().isoformat(),
                'total_atletas': len(data.get('atletas', {})),
                'processed_atletas': processed_count,
                'skipped_atletas': skipped_count,
                'total_clubes': len(data.get('clubes', {})),
                'rodada_atual': market_status.get('rodada_atual', 'N/A'),
                'status_mercado': market_status.get('status_mercado', 'N/A'),
                'success': True,
                'api_response_size': len(str(data)),
                'clubs_found': len([c for c in club_mapping.values() if any(atleta.get('clube_id') == club_id for atleta in data.get('atletas', {}).values() for club_id in [c])])
            }
            
            with open('update_log.json', 'w') as logfile:
                json.dump(log_data, logfile, indent=2)
            
            print(f"âœ… CSV atualizado com sucesso!")
            print(f"ğŸ“Š EstatÃ­sticas:")
            print(f"   - Total de atletas na API: {len(data.get('atletas', {}))}")
            print(f"   - Atletas processados: {processed_count}")
            print(f"   - Atletas ignorados: {skipped_count}")
            print(f"   - Clubes: {len(data.get('clubes', {}))}")
            print(f"   - Rodada atual: {market_status.get('rodada_atual', 'N/A')}")
            print(f"   - Status do mercado: {market_status.get('status_mercado', 'N/A')}")
            
            # Definir outputs para o GitHub Actions
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"success=true\n")
                f.write(f"processed_count={processed_count}\n")
                f.write(f"total_atletas={len(data.get('atletas', {}))}\n")
                f.write(f"skipped_count={skipped_count}\n")
                f.write(f"rodada_atual={market_status.get('rodada_atual', 'N/A')}\n")
                f.write(f"status_mercado={market_status.get('status_mercado', 'N/A')}\n")
            
        except Exception as e:
            print(f"âŒ Erro crÃ­tico: {str(e)}")
            print(f"ğŸ” Tipo do erro: {type(e).__name__}")
            
            # Log de erro detalhado
            error_log = {
                'timestamp': datetime.now().isoformat(),
                'error': str(e),
                'error_type': type(e).__name__,
                'success': False
            }
            
            with open('update_log.json', 'w') as logfile:
                json.dump(error_log, logfile, indent=2)
            
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"success=false\n")
                f.write(f"error={str(e)}\n")
                f.write(f"error_type={type(e).__name__}\n")
            
            # NÃ£o fazer exit(1) para permitir que o workflow continue e faÃ§a log
            print("âš ï¸ Continuando execuÃ§Ã£o para logging...")
        EOF
    
    - name: ğŸ“ Verificar mudanÃ§as no CSV
      id: check-changes
      if: steps.fetch-data.outputs.success == 'true'
      run: |
        if git diff --quiet cartola_jogadores_time_posicao_preco.csv; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Nenhuma mudanÃ§a detectada no CSV"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ”„ MudanÃ§as detectadas no CSV"
        fi
    
    - name: ğŸ’¾ Commit e Push das mudanÃ§as
      if: steps.fetch-data.outputs.success == 'true' && (steps.check-changes.outputs.changes == 'true' || github.event.inputs.force_update == 'true')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - CSV Update"
        
        # Adicionar arquivos modificados
        git add cartola_jogadores_time_posicao_preco.csv
        git add update_log.json
        
        # Criar commit com informaÃ§Ãµes detalhadas
        COMMIT_MSG="ğŸ”„ AtualizaÃ§Ã£o automÃ¡tica do CSV
        
        ğŸ“Š EstatÃ­sticas:
        - Atletas processados: ${{ steps.fetch-data.outputs.processed_count }}
        - Total de atletas: ${{ steps.fetch-data.outputs.total_atletas }}
        - Atletas ignorados: ${{ steps.fetch-data.outputs.skipped_count }}
        - Rodada atual: ${{ steps.fetch-data.outputs.rodada_atual }}
        - Status do mercado: ${{ steps.fetch-data.outputs.status_mercado }}
        - Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ğŸ¤– AtualizaÃ§Ã£o automÃ¡tica via GitHub Actions"
        
        git commit -m "$COMMIT_MSG"
        git push
        
        echo "âœ… CSV atualizado e enviado para o repositÃ³rio!"
    
    - name: ğŸ“Š Resumo da execuÃ§Ã£o
      if: always()
      run: |
        echo "## ğŸ“Š Resumo da AtualizaÃ§Ã£o do CSV" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.fetch-data.outputs.success }}" == "true" ]; then
          echo "âœ… **Status**: Sucesso" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **Atletas processados**: ${{ steps.fetch-data.outputs.processed_count }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ† **Total de atletas**: ${{ steps.fetch-data.outputs.total_atletas }}" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Atletas ignorados**: ${{ steps.fetch-data.outputs.skipped_count }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¯ **Rodada atual**: ${{ steps.fetch-data.outputs.rodada_atual }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ˆ **Status do mercado**: ${{ steps.fetch-data.outputs.status_mercado }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
            echo "ğŸ”„ **MudanÃ§as**: CSV foi atualizado" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ“Š **MudanÃ§as**: Nenhuma mudanÃ§a detectada" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Status**: Erro" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš¨ **Erro**: ${{ steps.fetch-data.outputs.error }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ” **Tipo do erro**: ${{ steps.fetch-data.outputs.error_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ **PossÃ­veis soluÃ§Ãµes**:" >> $GITHUB_STEP_SUMMARY
          echo "- API do Cartola pode estar temporariamente indisponÃ­vel" >> $GITHUB_STEP_SUMMARY
          echo "- Execute novamente manualmente em alguns minutos" >> $GITHUB_STEP_SUMMARY
          echo "- Verifique se o mercado estÃ¡ aberto" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¤– **Executado por**: GitHub Actions" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”„ **PrÃ³xima execuÃ§Ã£o**: A cada 6 horas" >> $GITHUB_STEP_SUMMARY
